<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio Sesi√≥n - Registro</title>
    <link rel="icon" href="Imagenes/Logo Restaurante.PNG">
    <link rel="stylesheet" href="CSS/InicioSs.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

</head>
<body class="locked">
    <!-- Pantalla de carga -->
    <div id="loading-screen">
      <i class='bx bxs-user-circle'></i>
    </div>

    <!-- Bot√≥n de retroceso -->
    <button class="back-btn" onclick="window.history.back()">
        <i class='bx bx-x'></i>
    </button>

<script>
    window.addEventListener("load", function() {
        let loadingScreen = document.getElementById("loading-screen");
        loadingScreen.classList.add("hidden");
        setTimeout(() => {
            loadingScreen.style.display = "none";
        }, 1000);
    });
</script>

    <div class="wrapper">
        <div class="form-container">
            <!-- FORMULARIO DE LOGIN -->
            <form id="loginForm" class="form active">
                <h2>Inicia Sesi√≥n</h2>
                <div class="input-field">
                    <input type="email" id="loginEmail" required>
                    <label for="loginEmail">Escribe tu email</label>
                    <p class="error" id="loginEmailError">Por favor, introduce un correo v√°lido.</p>
                </div>
                <div class="input-field">
                    <input type="password" id="loginPassword" required minlength="6">
                    <label for="loginPassword">Escribe tu contrase√±a</label>
                    <p class="error" id="loginPasswordError">La contrase√±a debe tener al menos 6 caracteres.</p>
                </div>
                <div class="forget">
                    <label for="remember">
                        <input type="checkbox" id="remember">
                        <p>Recordar</p>
                    </label>
                    <a href="#" id="forgotPasswordLink" style="color: #667eea; text-decoration: none; font-size: 14px;">
    ¬øOlvidaste tu contrase√±a?
</a>
                </div>
                <button type="submit">Entrar</button>
                <div class="social-buttons">
                    <button type="button" id="googleSignInButton" class="google-button">
                        <img src="Imagenes/Google.png" alt="Google" class="social-icon"> Iniciar sesi√≥n con Google
                    </button>
                    <button type="button" class="facebook-button">
                        <img src="Imagenes/Facebook.png" alt="Facebook" class="social-icon"> Iniciar sesi√≥n con Facebook
                    </button>
                </div>
                <p class="toggle-link">
                    ¬øNo tienes cuenta? <span onclick="toggleForms()">Crear cuenta</span>
                </p>
            </form>

            <!-- FORMULARIO DE REGISTRO -->
            <form id="registerForm" class="form inactive register-form">
                <h2>Crear Cuenta</h2>
                <div class="input-field">
                    <input type="text" id="registerName" required>
                    <label for="registerName">Nombre completo</label>
                    <p class="error" id="registerNameError">Por favor, introduce tu nombre.</p>
                </div>
                <div class="input-field">
                    <input type="email" id="registerEmail" required>
                    <label for="registerEmail">Correo electr√≥nico</label>
                    <p class="error" id="registerEmailError">Por favor, introduce un correo v√°lido.</p>
                    <p class="success" id="registerEmailSuccess">Correo v√°lido ‚úì</p>
                </div>
                <div class="input-field">
                    <input type="password" id="registerPassword" required minlength="6">
                    <label for="registerPassword">Contrase√±a</label>
                    <p class="error" id="registerPasswordError">La contrase√±a debe tener al menos 6 caracteres.</p>
                    <div class="password-strength" id="passwordStrength"></div>
                </div>
                <div class="input-field">
                    <input type="password" id="confirmPassword" required minlength="6">
                    <label for="confirmPassword">Confirmar contrase√±a</label>
                    <p class="error" id="confirmPasswordError">Las contrase√±as no coinciden.</p>
                    <p class="success" id="confirmPasswordSuccess">Las contrase√±as coinciden ‚úì</p>
                </div>
                <button type="submit">Crear Cuenta</button>
                <p class="toggle-link">
                    ¬øYa tienes cuenta? <span onclick="toggleForms()">Iniciar sesi√≥n</span>
                </p>
            </form>

            <!-- PANEL DE USUARIO LOGUEADO -->
            <div id="userPanel" class="form inactive">
                <div class="user-profile-header">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNmMGYwZjAiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM3IiByPSIxMyIgZmlsbD0iIzk5OSIvPjxwYXRoIGQ9Im0yNSA3NWMwLTE0IDExLTI1IDI1LTI1czI1IDExIDI1IDI1eiIgZmlsbD0iIzk5OSIvPjwvc3ZnPg=='">
                        <button class="change-photo-btn" onclick="changeProfilePhoto()">
                            <i class='bx bx-camera'></i>
                        </button>
                    </div>
                    <h2 id="userName">Usuario</h2>
                    <p id="userEmail" class="user-email">email@example.com</p>
                    <div class="user-status">
                        <span id="userStatus" class="status-badge">‚úÖ Perfil Completo</span>
                    </div>
                </div>

                <div class="user-info-section">
                    <h3>Informaci√≥n Personal</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <i class='bx bx-phone'></i>
                            <div>
                                <label>Tel√©fono</label>
                                <span id="userPhone">No registrado</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-id-card'></i>
                            <div>
                                <label>Documento</label>
                                <span id="userDocument">No registrado</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-map'></i>
                            <div>
                                <label>Ubicaci√≥n</label>
                                <span id="userLocation">No registrada</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class='bx bx-home'></i>
                            <div>
                                <label>Direcci√≥n</label>
                                <span id="userAddress">No registrada</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="user-actions">
                    <button type="button" class="edit-profile-btn" onclick="editProfile()">
                        <i class='bx bx-edit'></i> Editar Perfil
                    </button>
                    <button type="button" class="logout-btn" onclick="logoutUser()">
                        <i class='bx bx-log-out'></i> Cerrar Sesi√≥n
                    </button>
                </div>

                <div class="account-info">
                    <small>Cuenta creada: <span id="accountCreated">--</span></small><br>
                    <small>√öltimo acceso: <span id="lastLogin">--</span></small>
                </div>
            </div>

            <!-- FORMULARIO DE DATOS ADICIONALES -->
            <form id="additionalDataForm" class="form inactive additional-data-form">
                <h2>Completa tu Perfil</h2>
                <p class="subtitle">Necesitamos algunos datos adicionales para personalizar tu experiencia</p>
                
                <!-- Tel√©fono -->
                <div class="phone-input-container">
                    <div class="input-field country-code">
                        <select id="countryCode" required>
                            <option value="+57">üá®üá¥ +57</option>
                        </select>
                        <label for="countryCode">Pa√≠s</label>
                    </div>
                    <div class="input-field phone-number">
                        <input type="tel" id="phoneNumber" required maxlength="10" pattern="[3][0-9]{9}">
                        <label for="phoneNumber">N√∫mero de tel√©fono</label>
                        <p class="error" id="phoneError">Ingresa un n√∫mero v√°lido (debe iniciar con 3)</p>
                        <p class="success" id="phoneSuccess">N√∫mero v√°lido ‚úì</p>
                    </div>
                </div>

                <!-- Documento -->
                <div class="document-container">
                    <div class="input-field document-type">
                        <select id="documentType" required>
                            <option value="">Tipo</option>
                            <option value="CC">C√©dula</option>
                            <option value="TI">Tarjeta ID</option>
                            <option value="CE">C√©dula Ext</option>
                            <option value="PP">Pasaporte</option>
                        </select>
                        <label for="documentType">Documento</label>
                    </div>
                    <div class="input-field document-number">
                        <input type="text" id="documentNumber" required maxlength="15" pattern="[0-9]+">
                        <label for="documentNumber">N√∫mero de documento</label>
                        <p class="error" id="documentError">Solo n√∫meros, sin puntos ni comas</p>
                        <p class="success" id="documentSuccess">Documento v√°lido ‚úì</p>
                    </div>
                </div>

                <!-- Ubicaci√≥n -->
                <div class="department-city-container">
                    <div class="input-field department-field">
                        <select id="department" required>
                            <option value="">Departamento</option>
                            <option value="Amazonas">Amazonas</option>
                            <option value="Antioquia">Antioquia</option>
                            <option value="Arauca">Arauca</option>
                            <option value="Atl√°ntico">Atl√°ntico</option>
                            <option value="Bogot√° D.C.">Bogot√° D.C.</option>
                            <option value="Bol√≠var">Bol√≠var</option>
                            <option value="Boyac√°">Boyac√°</option>
                            <option value="Caldas">Caldas</option>
                            <option value="Caquet√°">Caquet√°</option>
                            <option value="Casanare">Casanare</option>
                            <option value="Cauca">Cauca</option>
                            <option value="Cesar">Cesar</option>
                            <option value="Choc√≥">Choc√≥</option>
                            <option value="C√≥rdoba">C√≥rdoba</option>
                            <option value="Cundinamarca">Cundinamarca</option>
                            <option value="Guain√≠a">Guain√≠a</option>
                            <option value="Guaviare">Guaviare</option>
                            <option value="Huila">Huila</option>
                            <option value="La Guajira">La Guajira</option>
                            <option value="Magdalena">Magdalena</option>
                            <option value="Meta">Meta</option>
                            <option value="Nari√±o">Nari√±o</option>
                            <option value="Norte de Santander">Norte de Santander</option>
                            <option value="Putumayo">Putumayo</option>
                            <option value="Quind√≠o">Quind√≠o</option>
                            <option value="Risaralda">Risaralda</option>
                            <option value="San Andr√©s y Providencia">San Andr√©s y Providencia</option>
                            <option value="Santander">Santander</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Tolima">Tolima</option>
                            <option value="Valle del Cauca">Valle del Cauca</option>
                            <option value="Vaup√©s">Vaup√©s</option>
                            <option value="Vichada">Vichada</option>
                        </select>
                        <label for="department">Departamento</label>
                    </div>
                    <div class="input-field city-field">
                        <input type="text" id="city" required>
                        <label for="city">Ciudad</label>
                        <p class="error" id="cityError">Por favor, ingresa tu ciudad</p>
                    </div>
                </div>

                <!-- Direcci√≥n -->
                <div class="input-field">
                    <input type="text" id="address" required>
                    <label for="address">Direcci√≥n completa</label>
                    <p class="error" id="addressError">Por favor, ingresa tu direcci√≥n</p>
                </div>

                <button type="submit">Guardar y Continuar</button>
                <button type="button" class="skip-button" onclick="skipAdditionalData()">Completar m√°s tarde</button>
            </form>

            <!-- FORMULARIO DE EDICI√ìN DE PERFIL -->
            <form id="editProfileForm" class="form inactive edit-profile-form">
                <h2>Editar Perfil</h2>
                <div class="input-field">
                    <input type="text" id="editName" required>
                    <label for="editName">Nombre completo</label>
                </div>
                
                <div class="phone-input-container">
                    <div class="input-field country-code">
                        <select id="editCountryCode" required>
                            <option value="+57">üá®üá¥ +57</option>
                        </select>
                        <label for="editCountryCode">Pa√≠s</label>
                    </div>
                    <div class="input-field phone-number">
                        <input type="tel" id="editPhoneNumber" required maxlength="10" pattern="[3][0-9]{9}">
                        <label for="editPhoneNumber">N√∫mero de tel√©fono</label>
                        <p class="error" id="editPhoneError">Ingresa un n√∫mero v√°lido (debe iniciar con 3)</p>
                    </div>
                </div>

                <div class="document-container">
                    <div class="input-field document-type">
                        <select id="editDocumentType" required>
                            <option value="">Tipo</option>
                            <option value="CC">C√©dula</option>
                            <option value="TI">Tarjeta ID</option>
                            <option value="CE">C√©dula Ext</option>
                            <option value="PP">Pasaporte</option>
                        </select>
                        <label for="editDocumentType">Documento</label>
                    </div>
                    <div class="input-field document-number">
                        <input type="text" id="editDocumentNumber" required maxlength="15" pattern="[0-9]+">
                        <label for="editDocumentNumber">N√∫mero de documento</label>
                        <p class="error" id="editDocumentError">Solo n√∫meros, sin puntos ni comas</p>
                    </div>
                </div>

                <div class="department-city-container">
                    <div class="input-field department-field">
                        <select id="editDepartment" required>
                            <option value="">Departamento</option>
                            <option value="Amazonas">Amazonas</option>
                            <option value="Antioquia">Antioquia</option>
                            <option value="Arauca">Arauca</option>
                            <option value="Atl√°ntico">Atl√°ntico</option>
                            <option value="Bogot√° D.C.">Bogot√° D.C.</option>
                            <option value="Bol√≠var">Bol√≠var</option>
                            <option value="Boyac√°">Boyac√°</option>
                            <option value="Caldas">Caldas</option>
                            <option value="Caquet√°">Caquet√°</option>
                            <option value="Casanare">Casanare</option>
                            <option value="Cauca">Cauca</option>
                            <option value="Cesar">Cesar</option>
                            <option value="Choc√≥">Choc√≥</option>
                            <option value="C√≥rdoba">C√≥rdoba</option>
                            <option value="Cundinamarca">Cundinamarca</option>
                            <option value="Guain√≠a">Guain√≠a</option>
                            <option value="Guaviare">Guaviare</option>
                            <option value="Huila">Huila</option>
                            <option value="La Guajira">La Guajira</option>
                            <option value="Magdalena">Magdalena</option>
                            <option value="Meta">Meta</option>
                            <option value="Nari√±o">Nari√±o</option>
                            <option value="Norte de Santander">Norte de Santander</option>
                            <option value="Putumayo">Putumayo</option>
                            <option value="Quind√≠o">Quind√≠o</option>
                            <option value="Risaralda">Risaralda</option>
                            <option value="San Andr√©s y Providencia">San Andr√©s y Providencia</option>
                            <option value="Santander">Santander</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Tolima">Tolima</option>
                            <option value="Valle del Cauca">Valle del Cauca</option>
                            <option value="Vaup√©s">Vaup√©s</option>
                            <option value="Vichada">Vichada</option>
                        </select>
                        <label for="editDepartment">Departamento</label>
                    </div>
                    <div class="input-field city-field">
                        <input type="text" id="editCity" required>
                        <label for="editCity">Ciudad</label>
                        <p class="error" id="editCityError">Por favor, ingresa tu ciudad</p>
                    </div>
                </div>

                <div class="input-field">
                    <input type="text" id="editAddress" required>
                    <label for="editAddress">Direcci√≥n completa</label>
                    <p class="error" id="editAddressError">Por favor, ingresa tu direcci√≥n</p>
                </div>

                <button type="submit">Guardar Cambios</button>
                <button type="button" class="cancel-button" onclick="cancelEditProfile()">Cancelar</button>
            </form>
        </div>
    </div>
    <!-- Modal para recuperaci√≥n de contrase√±a -->
<div id="passwordResetModal" class="reset-modal">
  <div class="reset-modal-content">
    <span class="close-reset-modal">&times;</span>
    <div class="reset-modal-header">
      <i class='bx bx-lock-alt'></i>
      <h3>Recuperar contrase√±a</h3>
    </div>
    <div class="reset-modal-body">
      <div class="input-field">
        <input type="email" id="resetEmail" required>
        <label for="resetEmail">Correo electr√≥nico registrado</label>
        <p class="error" id="resetEmailError"></p>
      </div>
    </div>
    <div class="reset-modal-footer">
      <button id="cancelResetBtn" class="cancel-btn">Cancelar</button>
      <button id="confirmResetBtn" class="confirm-btn">Enviar enlace</button>
    </div>
  </div>
</div>

<script>
    // ========== CONFIGURACI√ìN DE FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyCbemUTCYHJYcbiX5U4DaQuaJa8Mh6EdyY",
        authDomain: "login-pagina-9a2b2.firebaseapp.com",
        projectId: "login-pagina-9a2b2",
        storageBucket: "login-pagina-9a2b2.appspot.com",
        messagingSenderId: "676654795358",
        appId: "1:676654795358:web:c455962c22670fd0b002cf",
        measurementId: "G-TE86DMGMBV"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ========== VARIABLES GLOBALES ==========
    let currentForm = 'login';
    let currentUser = null;

    // ========== FUNCIONES DE NAVEGACI√ìN ==========
    function showForm(formName) {
        document.querySelectorAll('.form').forEach(form => {
            form.classList.remove('active');
            form.classList.add('inactive');
        });

        const targetForm = formName === 'user' ? document.getElementById('userPanel') :
                          formName === 'editProfile' ? document.getElementById('editProfileForm') :
                          document.getElementById(formName + 'Form');
        
        if (targetForm) {
            targetForm.classList.remove('inactive');
            targetForm.classList.add('active');
            currentForm = formName;
        }
    }

    function toggleForms() {
        showForm(currentForm === 'login' ? 'register' : 'login');
        clearFormErrors();
    }

    function clearFormErrors() {
        document.querySelectorAll('.error').forEach(el => el.classList.remove('show'));
        document.querySelectorAll('.success').forEach(el => el.classList.remove('show'));
    }

    // ========== FUNCIONES DE VALIDACI√ìN ==========
    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function validateColombianPhone(phone) {
        return /^3[0-9]{9}$/.test(phone);
    }

    function validateDocument(docNumber) {
        return /^[0-9]+$/.test(docNumber) && docNumber.length >= 6 && docNumber.length <= 15;
    }

    // Funci√≥n para crear un ID personalizado basado en el nombre
    function createCustomId(name) {
        return name.toLowerCase()
            .normalize('NFD') // Descomponer caracteres con tildes
            .replace(/[\u0300-\u036f]/g, '') // Eliminar tildes
            .replace(/\s+/g, '_') // Espacios por guiones bajos
            .replace(/[^a-z0-9_]/g, '') // Solo letras, n√∫meros y guiones bajos
            .substring(0, 50); // Limitar longitud
    }

    // Funci√≥n para verificar si un ID ya existe
    async function checkIdExists(customId) {
        try {
            const doc = await db.collection('users').doc(customId).get();
            return doc.exists;
        } catch (error) {
            return false;
        }
    }

    // Funci√≥n para generar un ID √∫nico
    async function generateUniqueId(name) {
        let baseId = createCustomId(name);
        let customId = baseId;
        let counter = 1;
        
        while (await checkIdExists(customId)) {
            customId = `${baseId}_${counter}`;
            counter++;
        }
        
        return customId;
    }

    function getFirebaseErrorMessage(errorCode) {
        const messages = {
            'auth/user-not-found': 'No existe una cuenta con este correo electr√≥nico.',
            'auth/wrong-password': 'Contrase√±a incorrecta.',
            'auth/email-already-in-use': 'Ya existe una cuenta con este correo electr√≥nico.',
            'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres.',
            'auth/invalid-email': 'El correo electr√≥nico no es v√°lido.',
            'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde.',
            'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet.',
            'default': 'Error de autenticaci√≥n. Intenta nuevamente.'
        };
        return messages[errorCode] || messages['default'];
    }

    // ========== FUNCIONES DE AUTENTICACI√ìN ==========
    async function registerUser(email, password, name) {
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await userCredential.user.updateProfile({ displayName: name });
            
            // Generar ID personalizado √∫nico
            const customId = await generateUniqueId(name);
            
            const userData = {
                name,
                email,
                createdAt: new Date().toISOString(),
                profileComplete: false,
                uid: userCredential.user.uid,
                customId: customId // Guardamos tambi√©n el ID personalizado
            };
            
            // Usar el ID personalizado en lugar del UID autom√°tico
            await db.collection('users').doc(customId).set(userData);
            return { success: true, user: { ...userData, docId: customId } };
        } catch (error) {
            return { success: false, message: getFirebaseErrorMessage(error.code) };
        }
    }

    async function loginUser(email, password) {
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            
            // Buscar el documento del usuario por UID o email
            let userDoc = null;
            let docId = null;
            
            // Primero intentar buscar por customId si existe
            const querySnapshot = await db.collection('users')
                .where('uid', '==', userCredential.user.uid)
                .get();
            
            if (!querySnapshot.empty) {
                userDoc = querySnapshot.docs[0];
                docId = userDoc.id;
            } else {
                // Si no existe, buscar por el UID original
                userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                docId = userCredential.user.uid;
            }
            
            return {
                success: true,
                user: {
                    ...userDoc.data(),
                    uid: userCredential.user.uid,
                    email: userCredential.user.email,
                    docId: docId
                }
            };
        } catch (error) {
            return { success: false, message: getFirebaseErrorMessage(error.code) };
        }
    }

    async function loginWithGoogle() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await auth.signInWithPopup(provider);
            
            // Buscar si el usuario ya existe
            const querySnapshot = await db.collection('users')
                .where('uid', '==', result.user.uid)
                .get();
            
            let userDoc = null;
            let docId = null;
            
            if (!querySnapshot.empty) {
                userDoc = querySnapshot.docs[0];
                docId = userDoc.id;
            } else {
                // Si no existe, crear nuevo documento con ID personalizado
                const customId = await generateUniqueId(result.user.displayName);
                const userData = {
                    name: result.user.displayName,
                    email: result.user.email,
                    photoURL: result.user.photoURL,
                    createdAt: new Date().toISOString(),
                    profileComplete: false,
                    uid: result.user.uid,
                    customId: customId
                };
                
                await db.collection('users').doc(customId).set(userData);
                docId = customId;
                userDoc = { data: () => userData };
            }
            
            return {
                success: true,
                user: {
                    ...userDoc.data(),
                    uid: result.user.uid,
                    docId: docId
                }
            };
        } catch (error) {
            return { success: false, message: getFirebaseErrorMessage(error.code) };
        }
    }

    // ========== FUNCIONES DE PERFIL ==========
    async function saveProfileData(docId, data) {
        try {
            await db.collection('users').doc(docId).update({
                ...data,
                profileComplete: true,
                updatedAt: new Date().toISOString()
            });
            return { success: true };
        } catch (error) {
            return { success: false, message: 'Error al guardar los datos' };
        }
    }

    async function skipAdditionalData() {
        if (!currentUser) return;
        
        try {
            await db.collection('users').doc(currentUser.docId || currentUser.uid).update({
                profileComplete: false,
                skippedAt: new Date().toISOString()
            });
            
            currentUser.profileComplete = false;
            showUserPanel(currentUser);
        } catch (error) {
            console.error('Error al saltar datos:', error);
            alert('Error al continuar sin completar el perfil');
        }
    }

    function showUserPanel(user) {
        document.getElementById('userName').textContent = user.name || 'Usuario';
        document.getElementById('userEmail').textContent = user.email;
        
        if (user.photoURL) {
            document.getElementById('userAvatar').src = user.photoURL;
        }
        
        document.getElementById('userPhone').textContent = user.phone || 'No registrado';
        document.getElementById('userDocument').textContent = 
            user.documentType && user.documentNumber ? 
            `${user.documentType} ${user.documentNumber}` : 'No registrado';
        document.getElementById('userLocation').textContent = 
            user.city && user.department ? 
            `${user.city}, ${user.department}` : 'No registrada';
        document.getElementById('userAddress').textContent = user.address || 'No registrada';
        
        if (user.createdAt) {
            document.getElementById('accountCreated').textContent = 
                new Date(user.createdAt).toLocaleDateString('es-CO');
        }
        
        showForm('user');
    }

    function editProfile() {
        if (!currentUser) return;
        
        document.getElementById('editName').value = currentUser.name || '';
        document.getElementById('editPhoneNumber').value = currentUser.phone ? currentUser.phone.replace('+57', '') : '';
        document.getElementById('editDocumentType').value = currentUser.documentType || '';
        document.getElementById('editDocumentNumber').value = currentUser.documentNumber || '';
        document.getElementById('editDepartment').value = currentUser.department || '';
        document.getElementById('editCity').value = currentUser.city || '';
        document.getElementById('editAddress').value = currentUser.address || '';
        
        showForm('editProfile');
    }

    async function updateProfile() {
        const docId = currentUser?.docId || currentUser?.uid;
        if (!docId) return;
        
        const updatedData = {
            name: document.getElementById('editName').value.trim(),
            phone: `+57${document.getElementById('editPhoneNumber').value.trim()}`,
            documentType: document.getElementById('editDocumentType').value,
            documentNumber: document.getElementById('editDocumentNumber').value.trim(),
            department: document.getElementById('editDepartment').value,
            city: document.getElementById('editCity').value.trim(),
            address: document.getElementById('editAddress').value.trim()
        };
        
        const result = await saveProfileData(docId, updatedData);
        if (result.success) {
            currentUser = { ...currentUser, ...updatedData, profileComplete: true };
            showUserPanel(currentUser);
        } else {
            alert(result.message);
        }
    }

    function logoutUser() {
        auth.signOut().then(() => {
            currentUser = null;
            showForm('login');
            document.querySelectorAll('form').forEach(form => form.reset());
        });
    }

    // ========== EVENT LISTENERS ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const button = this.querySelector('button[type="submit"]');
            
            if (!validateEmail(email)) {
                document.getElementById('loginEmailError').classList.add('show');
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Iniciando sesi√≥n...';
            
            const result = await loginUser(email, password);
            
            if (result.success) {
                currentUser = result.user;
                handlePostLogin(result.user);
            } else {
                document.getElementById('loginPasswordError').textContent = result.message;
                document.getElementById('loginPasswordError').classList.add('show');
                button.textContent = 'Entrar';
                button.disabled = false;
            }
        });

        // Register Form
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const button = this.querySelector('button[type="submit"]');
            
            if (!name || !validateEmail(email) || password.length < 6) {
                if (!name) document.getElementById('registerNameError').classList.add('show');
                if (!validateEmail(email)) document.getElementById('registerEmailError').classList.add('show');
                if (password.length < 6) document.getElementById('registerPasswordError').classList.add('show');
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Creando cuenta...';
            
            const result = await registerUser(email, password, name);
            
            if (result.success) {
                currentUser = result.user;
                handlePostLogin(result.user);
            } else {
                document.getElementById('registerEmailError').textContent = result.message;
                document.getElementById('registerEmailError').classList.add('show');
                button.textContent = 'Crear Cuenta';
                button.disabled = false;
            }
        });

        // Additional Data Form
        document.getElementById('additionalDataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                phone: `+57${document.getElementById('phoneNumber').value.trim()}`,
                documentType: document.getElementById('documentType').value,
                documentNumber: document.getElementById('documentNumber').value.trim(),
                department: document.getElementById('department').value,
                city: document.getElementById('city').value.trim(),
                address: document.getElementById('address').value.trim()
            };
            
            const button = this.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Guardando...';
            
            const result = await saveProfileData(currentUser.docId || currentUser.uid, data);
            
            if (result.success) {
                currentUser = { ...currentUser, ...data, profileComplete: true };
                showUserPanel(currentUser);
            } else {
                alert(result.message);
                button.textContent = 'Guardar y Continuar';
                button.disabled = false;
            }
        });

        // Edit Profile Form
        document.getElementById('editProfileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateProfile();
        });

        // Google Login
        document.getElementById('googleSignInButton').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.textContent = 'Conectando...';
            
            const result = await loginWithGoogle();
            
            if (result.success) {
                currentUser = result.user;
                handlePostLogin(result.user);
            } else {
                alert(result.message);
                button.textContent = 'Iniciar con Google';
                button.disabled = false;
            }
        });

        // Modal de recuperaci√≥n de contrase√±a
        const modal = document.getElementById('passwordResetModal');
        const resetButton = document.getElementById('forgotPasswordLink');
        const closeModal = document.querySelector('.close-reset-modal');
        const sendResetButton = document.getElementById('confirmResetBtn');
        const cancelButton = document.getElementById('cancelResetBtn');

        resetButton.addEventListener('click', (e) => {
            e.preventDefault();
            modal.style.display = 'block';
            document.getElementById('resetEmail').value = '';
            document.getElementById('resetEmailError').textContent = '';
        });

        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        cancelButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        sendResetButton.addEventListener('click', async () => {
            const email = document.getElementById('resetEmail').value.trim();
            const errorElement = document.getElementById('resetEmailError');
            
            if (!email || !validateEmail(email)) {
                errorElement.textContent = 'Ingresa un correo v√°lido';
                return;
            }
            
            sendResetButton.textContent = 'Enviando...';
            sendResetButton.disabled = true;
            
            try {
                await auth.sendPasswordResetEmail(email);
                
                const modalContent = document.querySelector('.reset-modal-content');
                modalContent.innerHTML = `
                <div class="reset-modal-header">
                    <i class='bx bx-check-circle success-icon'></i>
                    <h3>¬°Enlace enviado!</h3>
                </div>
                <div class="reset-modal-body">
                    <p>Revisa tu correo electr√≥nico <strong>${email}</strong> y sigue las instrucciones.</p>
                    <p>¬øNo lo ves? Revisa tu carpeta de <strong>SPAM</strong>.</p>
                </div>
                <div class="reset-modal-footer">
                    <button onclick="document.getElementById('passwordResetModal').style.display='none'" class="confirm-btn">Entendido</button>
                </div>
                `;
                
            } catch (error) {
                sendResetButton.textContent = 'Enviar enlace';
                sendResetButton.disabled = false;
                errorElement.textContent = getFirebaseErrorMessage(error.code);
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Cerrar modal
        document.querySelector('.close-reset-modal').addEventListener('click', function() {
            document.getElementById('passwordResetModal').style.display = 'none';
        });

        // Inicializaci√≥n
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Buscar el documento del usuario
                const querySnapshot = await db.collection('users')
                    .where('uid', '==', user.uid)
                    .get();
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    currentUser = { 
                        ...userDoc.data(), 
                        uid: user.uid, 
                        email: user.email,
                        docId: userDoc.id
                    };
                } else {
                    // Documento con UID original
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUser = { 
                            ...userDoc.data(), 
                            uid: user.uid, 
                            email: user.email,
                            docId: user.uid
                        };
                    }
                }
                
                if (currentUser) {
                    handlePostLogin(currentUser);
                }
            } else {
                showForm('login');
            }
        });

        // Funciones globales
        window.toggleForms = toggleForms;
        window.skipAdditionalData = skipAdditionalData;
        window.editProfile = editProfile;
        window.cancelEditProfile = () => showUserPanel(currentUser);
        window.logoutUser = logoutUser;
    });

    function handlePostLogin(user) {
        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.style.display = 'flex';
        
        setTimeout(() => {
            loadingScreen.style.display = 'none';
            if (!user.profileComplete) {
                showForm('additionalData');
            } else {
                showUserPanel(user);
            }
        }, 1500);
    }
</script>
</body>
</html>